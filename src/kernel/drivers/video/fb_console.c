/*
 * fb_console.c - Framebuffer console implementation
 * version 0.0.1
 * Text console for VBE graphics mode
 */

#include "fb_console.h"
#include "graphics.h"
#include "../../stdint.h"

/* Console state */
static int cursor_x = 0;
static int cursor_y = 0;
static uint32_t fg_color = 0x00FFFFFF;  /* White */
static uint32_t bg_color = 0x00000000;  /* Black */

/* Font: 8x8 bitmap font */
static const uint8_t font[128][8] = {
    /* Space (32) */
    [32] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* ! (33) */
    [33] = {0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00},
    /* " (34) */
    [34] = {0x6C, 0x6C, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* # (35) */
    [35] = {0x6C, 0x6C, 0xFE, 0x6C, 0xFE, 0x6C, 0x6C, 0x00},
    /* $ (36) */
    [36] = {0x18, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x18, 0x00},
    /* % (37) */
    [37] = {0x00, 0xC6, 0xCC, 0x18, 0x30, 0x66, 0xC6, 0x00},
    /* & (38) */
    [38] = {0x38, 0x6C, 0x38, 0x76, 0xDC, 0xCC, 0x76, 0x00},
    /* ' (39) */
    [39] = {0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* ( (40) */
    [40] = {0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00},
    /* ) (41) */
    [41] = {0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00},
    /* * (42) */
    [42] = {0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00},
    /* + (43) */
    [43] = {0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00},
    /* , (44) */
    [44] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30},
    /* - (45) */
    [45] = {0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00},
    /* . (46) */
    [46] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00},
    /* / (47) */
    [47] = {0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x80, 0x00},
    /* 0-9 (48-57) */
    [48] = {0x7C, 0xC6, 0xCE, 0xD6, 0xE6, 0xC6, 0x7C, 0x00},
    [49] = {0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00},
    [50] = {0x7C, 0xC6, 0x06, 0x1C, 0x30, 0x66, 0xFE, 0x00},
    [51] = {0x7C, 0xC6, 0x06, 0x3C, 0x06, 0xC6, 0x7C, 0x00},
    [52] = {0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x1E, 0x00},
    [53] = {0xFE, 0xC0, 0xC0, 0xFC, 0x06, 0xC6, 0x7C, 0x00},
    [54] = {0x38, 0x60, 0xC0, 0xFC, 0xC6, 0xC6, 0x7C, 0x00},
    [55] = {0xFE, 0xC6, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00},
    [56] = {0x7C, 0xC6, 0xC6, 0x7C, 0xC6, 0xC6, 0x7C, 0x00},
    [57] = {0x7C, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0x78, 0x00},
    /* : (58) */
    [58] = {0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00},
    /* ; (59) */
    [59] = {0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30},
    /* < (60) */
    [60] = {0x06, 0x0C, 0x18, 0x30, 0x18, 0x0C, 0x06, 0x00},
    /* = (61) */
    [61] = {0x00, 0x00, 0x7E, 0x00, 0x00, 0x7E, 0x00, 0x00},
    /* > (62) */
    [62] = {0x60, 0x30, 0x18, 0x0C, 0x18, 0x30, 0x60, 0x00},
    /* ? (63) */
    [63] = {0x7C, 0xC6, 0x0C, 0x18, 0x18, 0x00, 0x18, 0x00},
    /* @ (64) */
    [64] = {0x7C, 0xC6, 0xDE, 0xDE, 0xDE, 0xC0, 0x78, 0x00},
    /* A-Z (65-90) */
    [65] = {0x38, 0x6C, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00},
    [66] = {0xFC, 0x66, 0x66, 0x7C, 0x66, 0x66, 0xFC, 0x00},
    [67] = {0x3C, 0x66, 0xC0, 0xC0, 0xC0, 0x66, 0x3C, 0x00},
    [68] = {0xF8, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00},
    [69] = {0xFE, 0x62, 0x68, 0x78, 0x68, 0x62, 0xFE, 0x00},
    [70] = {0xFE, 0x62, 0x68, 0x78, 0x68, 0x60, 0xF0, 0x00},
    [71] = {0x3C, 0x66, 0xC0, 0xC0, 0xCE, 0x66, 0x3A, 0x00},
    [72] = {0xC6, 0xC6, 0xC6, 0xFE, 0xC6, 0xC6, 0xC6, 0x00},
    [73] = {0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
    [74] = {0x1E, 0x0C, 0x0C, 0x0C, 0xCC, 0xCC, 0x78, 0x00},
    [75] = {0xE6, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0xE6, 0x00},
    [76] = {0xF0, 0x60, 0x60, 0x60, 0x62, 0x66, 0xFE, 0x00},
    [77] = {0xC6, 0xEE, 0xFE, 0xFE, 0xD6, 0xC6, 0xC6, 0x00},
    [78] = {0xC6, 0xE6, 0xF6, 0xDE, 0xCE, 0xC6, 0xC6, 0x00},
    [79] = {0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00},
    [80] = {0xFC, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00},
    [81] = {0x7C, 0xC6, 0xC6, 0xC6, 0xD6, 0xDE, 0x7C, 0x06},
    [82] = {0xFC, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0xE6, 0x00},
    [83] = {0x7C, 0xC6, 0x60, 0x38, 0x0C, 0xC6, 0x7C, 0x00},
    [84] = {0x7E, 0x7E, 0x5A, 0x18, 0x18, 0x18, 0x3C, 0x00},
    [85] = {0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00},
    [86] = {0xC6, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x10, 0x00},
    [87] = {0xC6, 0xC6, 0xD6, 0xFE, 0xFE, 0xEE, 0xC6, 0x00},
    [88] = {0xC6, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0xC6, 0x00},
    [89] = {0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x3C, 0x00},
    [90] = {0xFE, 0xC6, 0x8C, 0x18, 0x32, 0x66, 0xFE, 0x00},
    /* [ (91) */
    [91] = {0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00},
    /* \ (92) */
    [92] = {0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x02, 0x00},
    /* ] (93) */
    [93] = {0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00},
    /* ^ (94) */
    [94] = {0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00},
    /* _ (95) */
    [95] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF},
    /* ` (96) */
    [96] = {0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* a-z (97-122) */
    [97] = {0x00, 0x00, 0x78, 0x0C, 0x7C, 0xCC, 0x76, 0x00},
    [98] = {0xE0, 0x60, 0x7C, 0x66, 0x66, 0x66, 0xDC, 0x00},
    [99] = {0x00, 0x00, 0x7C, 0xC6, 0xC0, 0xC6, 0x7C, 0x00},
    [100] = {0x1C, 0x0C, 0x7C, 0xCC, 0xCC, 0xCC, 0x76, 0x00},
    [101] = {0x00, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0x7C, 0x00},
    [102] = {0x38, 0x6C, 0x60, 0xF8, 0x60, 0x60, 0xF0, 0x00},
    [103] = {0x00, 0x00, 0x76, 0xCC, 0xCC, 0x7C, 0x0C, 0xF8},
    [104] = {0xE0, 0x60, 0x6C, 0x76, 0x66, 0x66, 0xE6, 0x00},
    [105] = {0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00},
    [106] = {0x06, 0x00, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C},
    [107] = {0xE0, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0xE6, 0x00},
    [108] = {0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00},
    [109] = {0x00, 0x00, 0xEC, 0xFE, 0xD6, 0xD6, 0xD6, 0x00},
    [110] = {0x00, 0x00, 0xDC, 0x66, 0x66, 0x66, 0x66, 0x00},
    [111] = {0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0x00},
    [112] = {0x00, 0x00, 0xDC, 0x66, 0x66, 0x7C, 0x60, 0xF0},
    [113] = {0x00, 0x00, 0x76, 0xCC, 0xCC, 0x7C, 0x0C, 0x1E},
    [114] = {0x00, 0x00, 0xDC, 0x76, 0x60, 0x60, 0xF0, 0x00},
    [115] = {0x00, 0x00, 0x7C, 0xC0, 0x7C, 0x06, 0xFC, 0x00},
    [116] = {0x30, 0x30, 0xFC, 0x30, 0x30, 0x36, 0x1C, 0x00},
    [117] = {0x00, 0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00},
    [118] = {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x6C, 0x38, 0x00},
    [119] = {0x00, 0x00, 0xC6, 0xD6, 0xD6, 0xFE, 0x6C, 0x00},
    [120] = {0x00, 0x00, 0xC6, 0x6C, 0x38, 0x6C, 0xC6, 0x00},
    [121] = {0x00, 0x00, 0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0xFC},
    [122] = {0x00, 0x00, 0x7E, 0x4C, 0x18, 0x32, 0x7E, 0x00},
    /* { (123) */
    [123] = {0x0E, 0x18, 0x18, 0x70, 0x18, 0x18, 0x0E, 0x00},
    /* | (124) */
    [124] = {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00},
    /* } (125) */
    [125] = {0x70, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x70, 0x00},
    /* ~ (126) */
    [126] = {0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
};

/* Character size - 8x12 for better readability */
#define CHAR_WIDTH 8
#define CHAR_HEIGHT 12

/* Console dimensions */
#define CONSOLE_COLS (GFX_WIDTH / CHAR_WIDTH)
#define CONSOLE_ROWS (GFX_HEIGHT / CHAR_HEIGHT)

/*
 * Draw a character at position (8x12 with 4 pixel spacing below)
 * Optimized version using batch operations
 */
static void draw_char(char c, int x, int y) {
    int i, j;
    uint8_t row;
    int px = x * CHAR_WIDTH;
    int py = y * CHAR_HEIGHT;
    uint32_t *buffer = gfx_get_double_buffer();
    int fb_width = gfx_get_width();
    
    if ((int)c < 32 || (int)c > 126) {
        c = '?';
    }
    
    /* Draw font rows (8 rows) - direct buffer access */
    for (i = 0; i < 8; i++) {
        row = font[(int)c][i];
        uint32_t *line_ptr = &buffer[(py + i) * fb_width + px];
        for (j = 0; j < 8; j++) {
            line_ptr[j] = (row & (0x80 >> j)) ? fg_color : bg_color;
        }
    }
    
    /* Draw 4 extra rows of background for spacing - use fill_rect */
    gfx_fill_rect(px, py + 8, CHAR_WIDTH, 4, bg_color);
}

/*
 * Scroll console up one line
 * Optimized version using batch copy
 */
static void scroll(void) {
    int fb_width = gfx_get_width();
    int fb_height = gfx_get_height();
    
    /* Copy all lines up at once using gfx_copy_rect */
    /* Source: line 1 to end, Destination: line 0 to end-1 */
    int scroll_height = (CONSOLE_ROWS - 1) * CHAR_HEIGHT;
    gfx_copy_rect(0, CHAR_HEIGHT, 0, 0, fb_width, scroll_height);
    
    /* Clear bottom line with fill_rect */
    int bottom_y = (CONSOLE_ROWS - 1) * CHAR_HEIGHT;
    gfx_fill_rect(0, bottom_y, fb_width, CHAR_HEIGHT, bg_color);
    
    gfx_swap_buffers();
}

/*
 * Initialize framebuffer console
 */
void fb_console_init(void) {
    cursor_x = 0;
    cursor_y = 0;
    fb_console_clear();
}

/*
 * Print a character
 */
void fb_putchar(char c) {
    if (c == '\n') {
        cursor_x = 0;
        cursor_y++;
        if (cursor_y >= CONSOLE_ROWS) {
            scroll();
            cursor_y = CONSOLE_ROWS - 1;
        }
        gfx_swap_buffers();  /* Flush on newline */
    } else if (c == '\r') {
        cursor_x = 0;
    } else if (c == '\t') {
        cursor_x = (cursor_x + 4) & ~3;
        if (cursor_x >= CONSOLE_COLS) {
            cursor_x = 0;
            cursor_y++;
            if (cursor_y >= CONSOLE_ROWS) {
                scroll();
                cursor_y = CONSOLE_ROWS - 1;
            }
        }
    } else if (c == '\b') {
        /* Backspace - move cursor back and clear character */
        if (cursor_x > 0) {
            cursor_x--;
            draw_char(' ', cursor_x, cursor_y);
        }
    } else if (c >= 32 && c <= 126) {
        draw_char(c, cursor_x, cursor_y);
        cursor_x++;
        if (cursor_x >= CONSOLE_COLS) {
            cursor_x = 0;
            cursor_y++;
            if (cursor_y >= CONSOLE_ROWS) {
                scroll();
                cursor_y = CONSOLE_ROWS - 1;
            }
        }
    }
    /* No gfx_swap_buffers here - only flush at end of fb_print or on newline */
}

/*
 * Print a string
 */
void fb_print(const char *str) {
    while (*str) {
        fb_putchar(*str++);
    }
    gfx_swap_buffers();  /* Flush after printing string */
}

/*
 * Convert nibble to hex character
 */
static char nibble_to_hex(uint8_t nibble) {
    nibble &= 0x0F;
    if (nibble < 10) {
        return '0' + nibble;
    } else {
        return 'A' + (nibble - 10);
    }
}

/*
 * Print hex number (without division or local arrays)
 */
void fb_print_hex(uint32_t value) {
    int i;
    
    fb_putchar('0');
    fb_putchar('x');
    
    /* Print each nibble from high to low */
    for (i = 28; i >= 0; i -= 4) {
        fb_putchar(nibble_to_hex((value >> i) & 0xF));
    }
}

/*
 * Print decimal number (without division or local arrays)
 */
void fb_print_int(int value) {
    uint32_t uvalue;
    uint32_t divisor;
    int started = 0;
    
    if (value < 0) {
        fb_putchar('-');
        uvalue = (uint32_t)(-value);
    } else {
        uvalue = (uint32_t)value;
    }
    
    /* Print digits from highest to lowest */
    for (divisor = 1000000000; divisor > 0; divisor /= 10) {
        uint8_t digit = (uint8_t)(uvalue / divisor);
        uvalue %= divisor;
        
        if (digit != 0 || started || divisor == 1) {
            fb_putchar('0' + digit);
            started = 1;
        }
    }
}

/*
 * Clear console
 */
void fb_console_clear(void) {
    gfx_clear(bg_color);
    cursor_x = 0;
    cursor_y = 0;
    gfx_swap_buffers();
}

/*
 * Reset cursor to top-left without clearing
 */
void fb_console_reset_cursor(void) {
    cursor_x = 0;
    cursor_y = 0;
}

/*
 * Flush buffer to screen (for interactive input)
 */
void fb_flush(void) {
    gfx_swap_buffers();
}

/*
 * Set text colors
 */
void fb_set_text_color(uint32_t fg, uint32_t bg) {
    fg_color = fg;
    bg_color = bg;
}
